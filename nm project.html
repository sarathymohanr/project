<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Token Refresh Demo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>JWT Token Refresh Demo</h1>
        <div class="controls">
            <button id="loginBtn">Login (Get Token)</button>
            <button id="protectedActionBtn" disabled>Protected Action</button>
            <button id="logoutBtn" disabled>Logout</button>
        </div>
        <p>Status: <span id="statusMessage">Awaiting login...</span></p>
    </div>
    <script src="script.js"></script>
</body>
</html>
<style>
body {
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: #f4f4f9;
    margin: 0;
}

.container {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    text-align: center;
}

.controls button {
    padding: 10px 15px;
    margin: 5px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background-color: #007bff;
    color: white;
}

.controls button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

#statusMessage {
    font-weight: bold;
    color: #333;
}
</style>
<script> 
    // --- Configuration & Constants ---
const ACCESS_TOKEN_KEY = 'accessToken';
const REFRESH_TOKEN_KEY = 'refreshToken';
const API_BASE_URL = 'http://localhost:3000'; // Replace with your actual backend URL
const TOKEN_EXPIRY_LEEWAY_MS = 60000; // Refresh token 60 seconds before actual expiry

// --- DOM Elements ---
const statusMessage = document.getElementById('statusMessage');
const loginBtn = document.getElementById('loginBtn');
const protectedActionBtn = document.getElementById('protectedActionBtn');
const logoutBtn = document.getElementById('logoutBtn');

// --- Helper Functions ---

/**
 * Decodes the JWT payload to get the expiry time (exp).
 * @param {string} token - The JWT string.
 * @returns {number | null} The expiry timestamp in seconds, or null if invalid.
 */
function decodeTokenExpiry(token) {
    try {
        const payload = token.split('.')[1];
        const decoded = JSON.parse(atob(payload));
        return decoded.exp; // Expiration time (in seconds since epoch)
    } catch (error) {
        console.error("Error decoding token:", error);
        return null;
    }
}

/**
 * Checks if the stored access token is expired or close to expiry.
 * @returns {boolean} True if the token needs to be refreshed.
 */
function isTokenExpired() {
    const accessToken = localStorage.getItem(ACCESS_TOKEN_KEY);
    if (!accessToken) return true;

    const expiryTimeSec = decodeTokenExpiry(accessToken);
    if (!expiryTimeSec) return true;

    // Convert expiry time to milliseconds and subtract the leeway
    const expiryTimeMs = expiryTimeSec * 1000 - TOKEN_EXPIRY_LEEWAY_MS;
    const nowMs = Date.now();

    return nowMs >= expiryTimeMs;
}

/**
 * Attempts to get a new Access Token using the stored Refresh Token.
 * @returns {Promise<boolean>} True if refresh was successful.
 */
async function refreshAccessToken() {
    const refreshToken = localStorage.getItem(REFRESH_TOKEN_KEY);
    if (!refreshToken) {
        setStatus('Refresh token missing. Please log in again.', 'red');
        return false;
    }

    setStatus('Attempting to refresh token...', 'orange');
    try {
        const response = await fetch(`${API_BASE_URL}/api/token/refresh`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ refreshToken })
        });

        if (response.ok) {
            const data = await response.json();
            // Store the new tokens
            localStorage.setItem(ACCESS_TOKEN_KEY, data.newAccessToken);
            localStorage.setItem(REFRESH_TOKEN_KEY, data.newRefreshToken || refreshToken); // Backend might return a new RT
            setStatus('Token refresh successful! âœ…', 'green');
            return true;
        } else {
            // Handle specific errors like expired refresh token
            setStatus('Refresh failed. Please log in again. ðŸ˜”', 'red');
            handleLogout();
            return false;
        }
    } catch (error) {
        console.error('Network error during token refresh:', error);
        setStatus('Network error during refresh. Try again.', 'red');
        return false;
    }
}

/**
 * A wrapper for fetch that handles token refresh before making the request.
 * @param {string} url - The API endpoint.
 * @param {object} options - Fetch options.
 */
async function fetchWithAuth(url, options = {}) {
    // 1. Check for expiry and refresh if needed
    if (isTokenExpired()) {
        const refreshSuccess = await refreshAccessToken();
        if (!refreshSuccess) {
            // Token refresh failed, cannot proceed with the request
            return new Response(null, { status: 401, statusText: 'Authorization Failed' });
        }
    }

    // 2. Add the current (potentially new) access token to the headers
    const accessToken = localStorage.getItem(ACCESS_TOKEN_KEY);
    const headers = {
        ...options.headers,
        'Authorization': `Bearer ${accessToken}`,
    };

    // 3. Perform the original request
    return fetch(url, { ...options, headers });
}

function setStatus(message, color = 'black') {
    statusMessage.textContent = message;
    statusMessage.style.color = color;
}

function updateUI() {
    const hasToken = !!localStorage.getItem(ACCESS_TOKEN_KEY);
    loginBtn.disabled = hasToken;
    protectedActionBtn.disabled = !hasToken;
    logoutBtn.disabled = !hasToken;
    if (hasToken) {
        setStatus('Ready. Token is active.', 'blue');
    } else {
        setStatus('Awaiting login...', 'black');
    }
}

// --- Event Handlers ---

async function handleLogin() {
    // In a real app, this would be a fetch to a /login endpoint
    // to exchange credentials for tokens.
    setStatus('Logging in...', 'blue');
    try {
        // Simulate a successful login and token reception
        const response = await fetch(`${API_BASE_URL}/api/login`, {
            method: 'POST',
            // In reality, this would contain username/password
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // --- SIMULATED TOKEN DATA ---
            // A short-lived access token (e.g., 5 min expiry) and a long-lived refresh token.
            const simulatedAccessToken = data.accessToken || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIxMjMiLCJpYXQiOjE2NzgwMzIwMDAsImV4cCI6MTY3ODA1MjEwMH0.s-h8T1f7w2x3y4z5a6b7c8d9e0f1g2h3i4j5k6l7m8n9o0p1q2r3s4t5u6v7w8x9y0z'; 
            const simulatedRefreshToken = data.refreshToken || 'simulated_refresh_token_xyz123';
            
            localStorage.setItem(ACCESS_TOKEN_KEY, simulatedAccessToken);
            localStorage.setItem(REFRESH_TOKEN_KEY, simulatedRefreshToken);

            setStatus('Login successful! Tokens stored. ðŸŽ‰', 'green');
            updateUI();
        } else {
             setStatus('Login failed. ðŸ˜”', 'red');
        }
    } catch (error) {
        setStatus('Network error during login.', 'red');
    }
}

async function handleProtectedAction() {
    setStatus('Requesting protected data...', 'blue');

    const url = `${API_BASE_URL}/api/protected`;
    const response = await fetchWithAuth(url, { method: 'GET' });

    if (response.ok) {
        const data = await response.json();
        setStatus(`Protected action successful! Data: ${JSON.stringify(data).substring(0, 50)}...`, 'green');
    } else if (response.status === 401) {
        // This should only happen if refresh also failed (e.g., Refresh Token expired)
        setStatus('Access denied. Please log in again.', 'red');
        handleLogout();
    } else {
        setStatus(`Protected action failed. Status: ${response.status}`, 'red');
    }
}

function handleLogout() {
    localStorage.removeItem(ACCESS_TOKEN_KEY);
    localStorage.removeItem(REFRESH_TOKEN_KEY);
    setStatus('Logged out successfully.', 'black');
    updateUI();
}

// --- Initialization ---
loginBtn.addEventListener('click', handleLogin);
protectedActionBtn.addEventListener('click', handleProtectedAction);
logoutBtn.addEventListener('click', handleLogout);

updateUI(); // Set initial button states
</script>